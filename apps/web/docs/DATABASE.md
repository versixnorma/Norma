# Versix Norma - Database Documentation

## 1. Core Schema Architecture

### User-Condominium Relationship (1:N)

The system uses a strict **1:N relationship** between Users (`usuarios`) and Condominiums (`condominios`).

- **One User** belongs to **One Condominium** at a time (referenced by `usuarios.condominio_id`).
- This design simplifies RLS (Row Level Security) and tenant isolation.
- **Legacy Note**: There is **no** `usuario_condominios` M:N join table. All queries must use the direct foreign key.

```sql
-- Correct Query Pattern
supabase
  .from('usuarios')
  .select('*, condominios:condominio_id(id, nome)')
  .eq('auth_id', user.id);
```

---

## 2. Key Database Views

These views abstract complex calculations (like quorum and voting results) to ensure consistency across Frontend and Mobile.

### `v_assembleia_quorum`

Calculates real-time presence and quorum status.

- **Columns**: `unidades_presentes`, `fracao_presente`, `quorum_percentual`, `status_quorum` ('sem_quorum', 'primeira_convocacao', etc.).
- **Usage**: Displaying "Live Quorum" bars in the Assembly dashboard.

### `v_pauta_resultado`

Aggregates votes for each agenda item (`pauta`).

- **Columns**: `votos_sim`, `votos_nao`, `percentual_aprovacao`.
- **Usage**: Showing voting results instantly after closure.

### `v_assembleia_resumo`

High-level summary for list views.

- **Combines**: Assembly details + Total Presence + Quorum Status.

---

## 3. Business Logic Functions (RPC)

All critical business logic is encapsulated in Postgres Functions to ensure data integrity and security.

### `registrar_presenca`

Registers a user's presence in an assembly.

- **Validates**: User active unit, existing presence, and proxy limits.
- **Params**: `assembleia_id`, `usuario_id`, `tipo` (presencial/online/procuracao).

### `registrar_voto`

The core voting engine with **Immutable Audit Trail**.

- **Features**:
  - Checks if user is allowed to vote (e.g., defaulter block).
  - Generates a **SHA-256 Hash** of the vote linked to the previous vote's hash (Blockchain-like).
  - Maintains vote secrecy if `pauta.voto_secreto` is true.

### `check_uh_user_limit` (Trigger)

Enforces tenant tier limits.

- **Logic**: Prevents adding more residents to a unit than allowed by the plan (Starter: 3, Pro: 5).

---

## 4. Security & RLS

### Soft Deletes

Data is rarely physically deleted.

- **Users**: `soft_delete_usuario(uid)` anonymizes PII (GDPR) and marks as removed.
- **Condos**: `soft_delete_condominio(id)` deactivates the tenant.

### Row Level Security (RLS)

- **SuperAdmin**: Full access.
- **Sindico**: Full access to their own `condominio_id`.
- **Morador**: Read-only access to their own data and published assemblies.

---

_Generated by Versix Norma Technical Team - Sprint 3_
