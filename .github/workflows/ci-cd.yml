name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '20.x'
  PNPM_VERSION: '9'
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  # ============================================
  # LINT & TYPE CHECK
  # ============================================
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm lint
        continue-on-error: true

      - name: Check ESLint warnings
        run: |
          LINT_OUTPUT=$(pnpm lint 2>&1 || true)
          echo "$LINT_OUTPUT"

          # Count actual lint problems (format: "line:col  warning/error  message")
          WARNING_COUNT=$(echo "$LINT_OUTPUT" | grep -cE "^\s+[0-9]+:[0-9]+\s+warning\s+" || true)
          ERROR_COUNT=$(echo "$LINT_OUTPUT" | grep -cE "^\s+[0-9]+:[0-9]+\s+error\s+" || true)

          MAX_WARNINGS=$(jq -r '.eslint.maxWarnings' .warnings-config.json)
          MAX_ERRORS=$(jq -r '.eslint.maxErrors' .warnings-config.json)

          echo ""
          echo "ESLint Warnings: $WARNING_COUNT (max: $MAX_WARNINGS)"
          echo "ESLint Errors: $ERROR_COUNT (max: $MAX_ERRORS)"

          if [ "$ERROR_COUNT" -gt "$MAX_ERRORS" ]; then
            echo "ESLint errors found ($ERROR_COUNT > $MAX_ERRORS). Failing build."
            exit 1
          fi

          if [ "$WARNING_COUNT" -gt "$MAX_WARNINGS" ]; then
            echo "Too many ESLint warnings ($WARNING_COUNT > $MAX_WARNINGS). Failing build."
            echo "Please fix warnings or update the warning limit in .warnings-config.json if necessary."
            exit 1
          fi

  # ============================================
  # DEPLOY PREVIEW (apenas para PRs)
  # ============================================
  deploy-preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    needs: lint
    if: github.event_name == 'pull_request'
    environment:
      name: preview
      url: ${{ steps.deploy.outputs.deployment_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Build Project Artifacts
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deploy to Vercel (Preview)
        id: deploy
        run: |
          DEPLOY_URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "deployment_url=$DEPLOY_URL" >> $GITHUB_OUTPUT
          echo "üöÄ Preview deployed to: $DEPLOY_URL"
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üöÄ **Preview Deploy**\n\nAplicativo dispon√≠vel em: ${{ steps.deploy.outputs.deployment_url }}\n\n**Credenciais de teste:**\n- Email: demo@versix.com.br\n- Senha: demo123`
            })

  # ============================================
  # DEPLOY PRODUCTION (apenas main branch)
  # ============================================
  deploy-production:
    name: Deploy Production
    runs-on: ubuntu-latest
    needs: lint
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://app.versixnorma.com.br
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Build Project Artifacts
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Upload sourcemaps to Sentry
        continue-on-error: true
        run: |
          cd apps/web
          pnpm dlx @sentry/cli sourcemaps upload .next/server/chunks --release versix-norma@${{ github.sha }} --dist ${{ github.run_number }}
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: versix-solutions
          SENTRY_PROJECT: versix-norma

      - name: Deploy Project Artifacts to Vercel
        run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Notify deployment success
        run: |
          echo "‚úÖ Deploy para produ√ß√£o conclu√≠do com sucesso!"
          echo "üåê URL: https://app.versixnorma.com.br"
